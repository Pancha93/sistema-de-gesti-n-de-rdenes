<div class="page-container">
  <!-- Overlay de carga -->
  <div class="loading-overlay" *ngIf="isLoading">
    <mat-spinner></mat-spinner>
    <p>Procesando archivo, por favor espere...</p>
  </div>

  <!-- Sección de bienvenida -->
  <mat-card class="welcome-section">
    <mat-card-content>
      <h1 class="welcome-title">Importación de Datos</h1>
      <p class="welcome-subtitle">Herramienta para importar datos desde archivos Excel y CSV</p>
      <div class="instructions">
        <mat-icon class="info-icon">info</mat-icon>
        <p><strong>Instrucciones importantes:</strong></p>
        <p>1. Antes de cargar su archivo, vaya a la página <a routerLink="/archivo-ejemplo" class="example-link">"Archivo Ejemplo"</a> para generar un archivo con la estructura correcta.</p>
        <p>2. Complete el archivo generado con sus datos reales.</p>
        <p>3. Regrese aquí y cargue el archivo completado.</p>
      </div>
    </mat-card-content>
  </mat-card>

  <!-- Paso 1: Cargar archivo -->
  <mat-card class="step-card">
    <mat-card-header>
      <mat-card-title>
        <mat-icon>upload_file</mat-icon>
        Paso 1: Cargar Archivo
      </mat-card-title>
    </mat-card-header>
    <mat-card-content>
      <div class="file-upload-section">
        <input type="file" #fileInput (change)="onFileSelected($event)" 
               accept=".xlsx,.xls,.csv" style="display: none;">
        <button mat-raised-button class="upload-button" (click)="fileInput.click()">
          <mat-icon>cloud_upload</mat-icon>
          Seleccionar Archivo (Excel o CSV)
        </button>
        <p *ngIf="selectedFile" class="file-info">
          <mat-icon>description</mat-icon>
          Archivo seleccionado: <strong>{{ selectedFile.name }}</strong>
        </p>
      </div>
    </mat-card-content>
  </mat-card>

  <!-- Vista previa del archivo -->
  <mat-card *ngIf="fileProcessed" class="preview-card">
    <mat-card-header>
      <mat-card-title>
        <mat-icon>preview</mat-icon>
        Vista Previa del Archivo
      </mat-card-title>
      <mat-card-subtitle>
        Encabezados detectados: {{ allFileHeaders.length }} | Registros de muestra: {{ fileData.length }}
      </mat-card-subtitle>
    </mat-card-header>
    <mat-card-content>
      <div class="table-scroll">
        <table mat-table [dataSource]="previewDataSource" class="mat-elevation-z8">
          <!-- Columnas dinámicas -->
          <ng-container *ngFor="let column of previewColumns" [matColumnDef]="column">
            <th mat-header-cell *matHeaderCellDef class="header-cell">{{ column }}</th>
            <td mat-cell *matCellDef="let element" class="data-cell">{{ element[column] }}</td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="previewColumns"></tr>
          <tr mat-row *matRowDef="let row; columns: previewColumns;"></tr>
        </table>
      </div>
    </mat-card-content>
  </mat-card>

  <!-- Seleccionar encabezados -->
  <mat-card *ngIf="fileProcessed && !headersSelected" class="step-card">
    <mat-card-header>
      <mat-card-title>
        <mat-icon>view_column</mat-icon>
         Seleccionar Encabezados
      </mat-card-title>
      <mat-card-subtitle>
        Seleccione los encabezados que desea importar
      </mat-card-subtitle>
    </mat-card-header>
    <mat-card-content>
      <div class="header-selection-container">
        <div class="header-selection-actions">
          <button mat-raised-button class="boton-crud" (click)="selectAllHeaders()">
            <mat-icon>select_all</mat-icon> Seleccionar Todos
          </button>
          <button mat-raised-button class="boton-crud" (click)="deselectAllHeaders()">
            <mat-icon>clear_all</mat-icon> Deseleccionar Todos
          </button>
        </div>

        <div class="header-chips-container">
          <mat-chip-set class="header-chips">
            <mat-chip-option *ngFor="let header of allFileHeaders"
                     [selected]="isHeaderSelected(header)"
                     (selectionChange)="toggleHeaderSelection(header)"
                     [class.selected-header]="isHeaderSelected(header)"
                     [class.unselected-header]="!isHeaderSelected(header)">
              {{ header }}
            </mat-chip-option>
          </mat-chip-set>
        </div>

        <div class="header-selection-info">
          <p>Encabezados seleccionados: {{ fileHeaders.length }} de {{ allFileHeaders.length }}</p>
        </div>

        <div class="header-selection-actions">
          <button mat-raised-button class="boton-crud" [disabled]="fileHeaders.length === 0" (click)="confirmHeaderSelection()">
            <mat-icon>check</mat-icon> Confirmar Selección
          </button>
        </div>
      </div>
    </mat-card-content>
  </mat-card>

  <!-- Paso 2: Seleccionar entidad -->
  <mat-card *ngIf="fileProcessed && headersSelected" class="step-card">
    <mat-card-header>
      <mat-card-title>
        <mat-icon>category</mat-icon>
        Paso 2: Seleccionar Entidad de Destino
      </mat-card-title>
    </mat-card-header>
    <mat-card-content>
      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Seleccione la entidad donde se guardarán los datos</mat-label>
        <mat-select [formControl]="entityControl">
          <mat-option *ngFor="let entity of availableEntities" [value]="entity">
            {{ entity }}
          </mat-option>
        </mat-select>
      </mat-form-field>
    </mat-card-content>
  </mat-card>

  <!-- Paso 3: Mapear campos -->
  <mat-card *ngIf="entitySelected" class="mapping-card">
    <mat-card-header>
      <mat-card-title>
        <mat-icon>compare_arrows</mat-icon>
        Paso 3: Mapear Campos
      </mat-card-title>
      <mat-card-subtitle>
        Configure cómo se mapearán los datos del archivo a los campos de la entidad. Recuerde que los tipos de datos del archivo deben de ser iguales a los campos de la entidad.
      </mat-card-subtitle>
    </mat-card-header>
    <mat-card-content>
      <div class="mapping-container">
        <div class="mapping-row" *ngFor="let mapping of fieldMappings; let i = index">
          <!-- Campo del archivo -->
          <div class="mapping-section file-section">
            <mat-form-field appearance="outline">
              <mat-label>Campo del Archivo</mat-label>
              <mat-select [value]="mapping.fileHeader" 
                         (selectionChange)="onHeaderSelectionChange(i, $event.value)">
                <mat-option *ngFor="let header of getAvailableHeadersForIndex(i)" [value]="header">
                  {{ header }}
                </mat-option>
              </mat-select>
            </mat-form-field>
          </div>

          <!-- Flecha y texto central -->
          <div class="mapping-section arrow-section">
            <mat-icon class="arrow-icon">arrow_forward</mat-icon>
            <p class="mapping-text">Estos datos se guardarán en:</p>
          </div>

          <!-- Campo de la entidad -->
          <div class="mapping-section entity-section">
            <mat-form-field appearance="outline">
              <mat-label>Campo de {{ selectedEntity }}</mat-label>
              <mat-select [value]="mapping.entityAttribute" 
                         (selectionChange)="onAttributeSelectionChange(i, $event.value)">
                <mat-option *ngFor="let attr of getAvailableAttributesForIndex(i)" [value]="attr.name">
                  {{ attr.name }} ({{ attr.type }})
                  <span *ngIf="attr.required" class="required-indicator">*</span>
                </mat-option>
              </mat-select>
            </mat-form-field>
          </div>
        </div>
      </div>
    </mat-card-content>
  </mat-card>

  <!-- Paso 4: Validar datos -->
  <mat-card *ngIf="mappingCompleted && !validationCompleted" class="validation-card">
    <mat-card-header>
      <mat-card-title>
        <mat-icon>verified</mat-icon>
        Paso 4: Validar Datos
      </mat-card-title>
      <mat-card-subtitle>
        Se validarán los datos del archivo para que cumplan las reglas de validación aplicadas a los tipos de datos que se seleccionaron para cada campo del archivo
      </mat-card-subtitle>
    </mat-card-header>
    <mat-card-content>
      <div class="validation-section">
        <div class="validation-info">
          <mat-icon class="info-icon">info</mat-icon>
          <p>La validación verificará:</p>
          <ul>
            <li>Que los tipos de datos coincidan con los campos de la entidad</li>
            <li>Que los campos requeridos no estén vacíos</li>
            <li>Que los formatos de fecha, hora y email sean correctos</li>
            <li>Que los números estén dentro de los rangos permitidos</li>
          </ul>
        </div>
        
        <div class="validation-actions">
          <button mat-raised-button class="validate-button" 
                  [disabled]="isLoading" 
                  (click)="validarDatos()">
            <mat-icon>check_circle</mat-icon>
            Validar Datos
          </button>
        </div>
      </div>
    </mat-card-content>
  </mat-card>

  <!-- Resultados de validación -->
  <mat-card *ngIf="validationCompleted" class="validation-results-card">
    <mat-card-header>
      <mat-card-title>
        <mat-icon [class]="hasValidationErrors ? 'status-warning' : 'status-success'">
          {{ hasValidationErrors ? 'warning' : 'check_circle' }}
        </mat-icon>
        Resultados de Validación
      </mat-card-title>
    </mat-card-header>
    <mat-card-content>
      <div class="validation-summary">
        <div class="summary-item valid-data">
          <mat-icon>check_circle</mat-icon>
          <span>Registros válidos: <strong>{{ validDataToImport.length }}</strong></span>
        </div>
        
        <div class="summary-item invalid-data" *ngIf="hasValidationErrors">
          <mat-icon>error</mat-icon>
          <span>Registros con errores: <strong>{{ invalidDataSummary.length }}</strong></span>
        </div>
      </div>
      
      <div class="validation-actions" *ngIf="hasValidationErrors">
        <button mat-raised-button class="download-errors-button" (click)="descargarResumenErrores()">
          <mat-icon>download</mat-icon>
          Descargar Resumen de Errores
        </button>
        
        <div class="error-explanation">
          <mat-icon>info</mat-icon>
          <p>Se pueden importar solo los registros válidos, o puede corregir los errores en el archivo y volver a cargarlo.</p>
        </div>
      </div>
    </mat-card-content>
  </mat-card>

      <!-- Información adicional para importación -->
      <div class="import-info" *ngIf="validDataToImport.length > 0">
        <div class="info-card">
          <mat-icon class="info-icon">info</mat-icon>
          <div class="info-content">
            <h4>Datos listos para importar:</h4>
            <p><strong>{{ validDataToImport.length }}</strong> registros válidos serán importados a la entidad <strong>{{ selectedEntity }}</strong></p>
            <p>Los datos se guardarán según el mapeo de campos configurado.</p>
          </div>
        </div>
      </div>
  <!-- Botones de acción con información de progreso -->
  <div class="action-buttons" *ngIf="validationCompleted">
    <div class="import-section">
      <button mat-raised-button class="import-button" 
              [disabled]="!mappingCompleted || validDataToImport.length === 0 || isLoading" 
              (click)="importarDatos()">
        <mat-icon>cloud_download</mat-icon>
        <span *ngIf="!isLoading">
          Importar {{ validDataToImport.length }} Registros por Lotes
        </span>
        <span *ngIf="isLoading">
          Importando por lotes...
        </span>
      </button>
      
      <!-- Indicador de progreso durante la importación -->
      <div class="import-progress" *ngIf="isLoading && batchProcessing">
        <div class="batch-progress">
          <div class="batch-info">
            <h4>Procesamiento por Lotes</h4>
            <p>Lote {{ currentBatch }} de {{ totalBatches }}</p>
            <p>Registros importados: {{ batchResults.imported }}</p>
            <p>Errores: {{ batchResults.errors.length }}</p>
          </div>
          <mat-progress-bar mode="determinate" [value]="batchProgress" color="primary"></mat-progress-bar>
          <p class="progress-text">{{ batchProgress.toFixed(1) }}% completado</p>
        </div>
      </div>
  <!-- Estado del mapeo -->
  <mat-card *ngIf="entitySelected" class="status-card">
    <mat-card-content>
      <div class="status-info">
        <mat-icon [class]="mappingCompleted ? 'status-success' : 'status-warning'">
          {{ mappingCompleted ? 'check_circle' : 'warning' }}
        </mat-icon>
        <span class="status-text">
          {{ mappingCompleted ? 'Mapeo completo - Listo para importar' : 'Complete el mapeo de todos los campos' }}
        </span>
      </div>
    </mat-card-content>
  </mat-card>
</div>
